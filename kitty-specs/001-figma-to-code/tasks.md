---
description: "Work package task list for Figma-to-Code Rule Builder implementation"
---
*Path: [kitty-specs/001-figma-to-code/tasks.md](kitty-specs/001-figma-to-code/tasks.md)*

# Work Packages: Figma-to-Code Rule Builder

**Inputs**: Design documents from `/kitty-specs/001-figma-to-code/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/planned/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; detailed implementation guidance lives in prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Next.js App Router**: `app/`, `components/`, `lib/`
- **Tests**: `__tests__/unit/`, `__tests__/integration/`, `__tests__/e2e/`
- Adjust paths to match the implementation plan.

---

## Work Package WP01: Project Setup & Foundation (Priority: P0) ðŸŽ¯ MVP Foundation

**Goal**: Initialize Next.js 14+ project with TypeScript strict mode, install dependencies, configure tooling, and establish file structure.
**Independent Test**: Run `npm run dev` successfully, navigate to http://localhost:3000, see placeholder page.
**Prompt**: `/tasks/planned/WP01-project-setup-and-foundation.md`

### Included Subtasks
- [ ] T001 Initialize Next.js 14+ project with App Router and TypeScript
- [ ] T002 Configure TypeScript strict mode in tsconfig.json
- [ ] T003 [P] Install core dependencies (React 18+, Next.js 14+, Monaco Editor, Shadcn/ui, Tailwind CSS)
- [ ] T004 [P] Setup Tailwind CSS configuration with Shadcn/ui integration
- [ ] T005 [P] Create project folder structure (app/, components/, lib/, __tests__/)
- [ ] T006 Create .env.local template and .gitignore (exclude figma-data/, mapping-rules.json)
- [ ] T007 [P] Initialize Vitest for unit tests, React Testing Library for component tests
- [ ] T008 [P] Setup Playwright for E2E tests
- [ ] T009 Create README.md with setup instructions
- [ ] T010 Verify build succeeds with zero TypeScript errors

### Implementation Notes
- Use `npx create-next-app@latest` with TypeScript and App Router options
- Shadcn/ui requires manual component installation (`npx shadcn-ui@latest init`)
- Create `figma-data/` and `mapping-rules.json` placeholders (git-ignored)
- Vitest config should exclude node_modules and use jsdom environment for React components

### Parallel Opportunities
- T003, T004, T007, T008 can run concurrently (different config files)

### Dependencies
- None (starting package).

### Risks & Mitigations
- **Dependency version conflicts**: Pin exact versions in package.json (Next.js 14.x, React 18.x)
- **Monaco Editor bundle size**: Use dynamic import in T003 setup notes

---

## Work Package WP02: TypeScript Types & Contracts (Priority: P0) ðŸŽ¯ MVP Foundation

**Goal**: Define all TypeScript types matching data-model.md and contracts/. Establish type-safe foundation for lib modules.
**Independent Test**: All type files compile with zero errors, can import and use types in test file.
**Prompt**: `/tasks/planned/WP02-typescript-types-and-contracts.md`

### Included Subtasks
- [ ] T011 [P] Create `lib/types/figma.ts` (FigmaNode, Paint, Color, Effect interfaces)
- [ ] T012 [P] Create `lib/types/altnode.ts` (AltNode, CSSProperties interfaces)
- [ ] T013 [P] Create `lib/types/rule.ts` (MappingRule, Selector, Transformer, RuleMatch interfaces)
- [ ] T014 [P] Create `lib/types/generated-code.ts` (GeneratedCode, CodeFormat, CodeMetadata)
- [ ] T015 Verify all types export correctly and compile with TypeScript strict mode
- [ ] T016 Create type guard functions in `lib/utils/validation.ts` for runtime checks

### Implementation Notes
- Follow exact type definitions from data-model.md
- Use discriminated unions for enum-like types (e.g., `type FigmaNodeType = 'FRAME' | 'TEXT' | ...`)
- Type guards should use `is` keyword (e.g., `function isFigmaNode(obj: unknown): obj is FigmaNode`)
- Add JSDoc comments to complex types

### Parallel Opportunities
- All T011-T014 can be created concurrently (no interdependencies)

### Dependencies
- Depends on WP01 (project structure exists).

### Risks & Mitigations
- **Type definition drift from Figma API**: Document Figma API version in comments (v1, 2025-11-23)

---

## Work Package WP03: Figma API Client & Caching (Priority: P1) ðŸŽ¯ MVP - User Story 1

**Goal**: Implement Figma REST API integration with server-side proxy, local filesystem caching, and error handling.
**Independent Test**: Call API route with valid token and node ID, verify figma-data/ files created, test offline mode.
**Prompt**: `/tasks/planned/WP03-figma-api-client-and-caching.md`

### Included Subtasks
- [x] T017 Create `lib/figma-client.ts` with fetchNode(), fetchVariables(), fetchScreenshot() functions
- [x] T018 Create `lib/utils/file-storage.ts` with saveFigmaData(), loadFigmaData() functions
- [x] T019 Implement `app/api/figma/fetch/route.ts` (POST: fetch node, save to cache)
- [x] T020 Implement `app/api/figma/refresh/route.ts` (POST: re-fetch with cache invalidation)
- [x] T021 Add error handling for API failures (auth, rate limits, network issues)
- [x] T022 Test with mock Figma API responses (use msw or similar)
- [x] T023 Verify offline mode: Load cached data without API call

### Implementation Notes
- Use `process.env.FIGMA_ACCESS_TOKEN` (server-side only, never expose to browser)
- Figma API endpoints: `GET /v1/files/{key}/nodes?ids={nodeId}`, `GET /v1/files/{key}/variables/local`, `GET /images/{key}?ids={nodeId}`
- Save to `figma-data/{nodeId}.json`, `{nodeId}-variables.json`, `{nodeId}-screenshot.png`
- Use Node.js `fs.promises` for async file operations

### Parallel Opportunities
- T017-T018 can be developed concurrently (different modules)

### Dependencies
- Depends on WP02 (FigmaNode types).

### Risks & Mitigations
- **Figma API rate limiting**: Implement exponential backoff, display user-friendly error
- **Large node trees**: Test with 100-node tree, monitor memory usage

---

## Work Package WP04: AltNode Transformation Engine (Priority: P1) ðŸŽ¯ MVP - User Story 1

**Goal**: Transform cached Figma JSON to normalized AltNode representation with CSS-familiar properties.
**Independent Test**: Load Figma JSON, transform to AltNode, verify CSS properties (display: flex, gap, background).
**Prompt**: `/tasks/planned/WP04-altnode-transformation-engine.md`

### Included Subtasks
- [ ] T024 Create `lib/altnode-transform.ts` with transformToAltNode() entry function
- [ ] T025 [P] Implement normalizeLayout() for auto-layout â†’ flexbox conversion
- [ ] T026 [P] Implement normalizeFills() for Figma fills â†’ CSS background
- [ ] T027 [P] Implement normalizeStrokes() for strokes â†’ CSS border
- [ ] T028 [P] Implement normalizeEffects() for effects â†’ CSS box-shadow
- [ ] T029 [P] Implement normalizeText() for text properties â†’ CSS font properties
- [ ] T030 Handle edge cases: absolute positioning in auto-layout, overlapping z-index, multi-style text runs
- [ ] T031 Test transformation with sample Figma JSON (horizontal layout, vertical layout, mixed)
- [ ] T032 Verify transformation performance (<50ms for 100-node tree)

### Implementation Notes
- Follow transformation rules from research.md (layoutMode HORIZONTAL â†’ display: flex + flexDirection: row)
- Preserve original Figma properties in `altNode.figmaProperties` for reference
- Use recursive tree traversal for children
- Handle null/undefined Figma properties gracefully (use optional chaining)

### Parallel Opportunities
- T025-T029 normalization functions can be developed concurrently

### Dependencies
- Depends on WP02 (AltNode types), WP03 (Figma data available).

### Risks & Mitigations
- **Figma property combinations not covered**: Document known limitations, add TODO comments for future

---

## Work Package WP05: Rule Engine & Conflict Resolution (Priority: P1) ðŸŽ¯ MVP - User Story 2 & 3

**Goal**: Implement rule matching, priority-based conflict resolution, and property composition logic.
**Independent Test**: Create 2 rules with conflicts, evaluate against AltNode, verify resolved properties follow priority.
**Prompt**: `/tasks/planned/WP05-rule-engine-and-conflict-resolution.md`

### Included Subtasks
- [ ] T033 Create `lib/rule-engine.ts` with evaluateRules(altNode, rules) function
- [ ] T034 Implement selectorMatches(altNode, selector) for pattern matching (AND logic)
- [ ] T035 Implement resolveConflicts(matches) for priority-based property composition
- [ ] T036 Add conflict detection logic (minor vs major conflicts)
- [ ] T037 Track property provenance (which rule contributed which property)
- [ ] T038 Test with multiple rules matching same node, verify composition and override behavior
- [ ] T039 Benchmark rule matching performance (<10ms for 50 rules Ã— 100 nodes)

### Implementation Notes
- Selector matching: All selector properties must match (AND logic, not OR)
- Priority sorting: Descending order (highest priority first)
- Conflict resolution: Property-level, not rule-level (rules compose where they don't conflict)
- Return RuleMatch[] with ruleId, priority, contributedProperties, conflicts

### Parallel Opportunities
- T034-T036 can be developed in parallel if function signatures agreed upfront

### Dependencies
- Depends on WP02 (MappingRule, RuleMatch types), WP04 (AltNode available).

### Risks & Mitigations
- **Performance with many rules**: Profile with 100 rules Ã— 100 nodes, optimize if >100ms total

---

## Work Package WP06: Code Generators (Priority: P1) ðŸŽ¯ MVP - User Story 3

**Goal**: Generate React JSX, React+Tailwind, and HTML/CSS from AltNode + resolved rules.
**Independent Test**: Pass AltNode with resolved properties, verify generated code is syntactically valid and matches expected output.
**Prompt**: `/tasks/planned/WP06-code-generators.md`

### Included Subtasks
- [X] T040 [P] Create `lib/code-generators/react.ts` for React JSX with inline styles
- [X] T041 [P] Create `lib/code-generators/react-tailwind.ts` for React with Tailwind utility classes
- [X] T042 [P] Create `lib/code-generators/html-css.ts` for HTML + separate CSS
- [X] T043 Implement helper functions: toPascalCase(), cssObjectToString(), convertToTailwindClasses()
- [X] T044 Add syntax highlighting preparation (Prism.js or Shiki integration research)
- [X] T045 Test generated code compiles/renders correctly (React JSX â†’ JSX parser, HTML â†’ DOM parser)
- [X] T046 Verify generated code readability (proper indentation, line breaks)

**Status**: âœ… DONE - Reviewed and approved (2025-11-23)
**Prompt File**: `tasks/done/WP06-code-generators.md`

### Implementation Notes
- Template-based generation (string interpolation, not AST manipulation)
- React JSX: Export function components with inline styles as `React.CSSProperties`
- React+Tailwind: Map CSS properties to Tailwind classes (e.g., `display: flex` â†’ `className="flex"`)
- HTML/CSS: Generate separate `.css` file with class selectors
- Recursive generation for nested children

### Parallel Opportunities
- T040-T042 can be developed concurrently (independent generators)

### Dependencies
- Depends on WP02 (GeneratedCode types), WP05 (resolved properties available).

### Risks & Mitigations
- **CSS-to-Tailwind mapping incomplete**: Start with common properties (flex, gap, padding, background), add more incrementally

---

## Work Package WP07: Main UI Layout & Fetch Flow (Priority: P1) ðŸŽ¯ MVP - User Story 1

**Goal**: Build three-panel interface (tree, editor, previews) and implement Figma node fetch workflow.
**Independent Test**: Enter Figma URL + node ID, click fetch, see AltNode tree in left panel.
**Prompt**: `/tasks/done/WP07-main-ui-layout.md`

**Status**: âœ… DONE - Reviewed and approved (2025-11-23)

### Included Subtasks
- [x] T047 Create `app/page.tsx` with three-panel layout (Shadcn/ui ResizablePanels)
- [x] T048 Create input form for Figma URL and node ID (Shadcn/ui Input, Button components)
- [x] T049 Implement fetch handler: call `/api/figma/fetch`, handle loading/error states
- [x] T050 Create `components/figma-tree-view.tsx` for recursive AltNode tree display
- [x] T051 Add visual indicators (colored badges) for rule match counts on tree nodes
- [x] T052 Style panels with Tailwind CSS (responsive, clean dev tool aesthetic)
- [x] T053 Test full fetch flow: valid URL â†’ loading â†’ success â†’ tree displayed

### Implementation Notes
- Use Next.js App Router `useState` for client-side state (Figma URL, fetched data, loading)
- Tree view: Recursive component rendering children with indentation
- Match count badges: Display number of matching rules (computed via rule engine)
- Loading state: Shadcn/ui Spinner, error state: Alert component

### Parallel Opportunities
- T050-T051 (tree view) can be developed while T047-T049 (fetch flow) is in progress

### Dependencies
- Depends on WP03 (API routes), WP04 (AltNode transformation), WP01 (Shadcn/ui setup).

### Risks & Mitigations
- **Deep nesting performance**: Use React.memo for tree nodes, virtualize if >500 nodes

---

## Work Package WP13: FigmaToCode Improvements (Priority: P0) ðŸ”¥ CRITICAL - Complete Before WP08

**Goal**: Integrate 23 recommendations from FigmaToCode analysis to fix critical gaps and improve transformation quality before continuing with Monaco Editor and preview features.
**Independent Test**: Run existing tests with enhanced types and edge case handling; verify invisible nodes filtered, GROUP nodes inlined, rotation preserved.
**Prompt**: `/tasks/planned/WP13-figmatocode-improvements.md`

### Included Subtasks

#### CRITICAL Fixes (Block WP08-WP12)
- [x] T090 Add `originalNode: FigmaNode` property to `AltNode` interface (lib/types/altnode.ts)
- [x] T091 Add missing Figma properties to `FigmaNode` type: strokeTopWeight, strokeBottomWeight, strokeLeftWeight, strokeRightWeight, layoutSizingHorizontal, layoutSizingVertical, layoutWrap, primaryAxisAlignItems, counterAxisAlignItems, rotation, visible, blendMode, opacity (lib/types/figma.ts)
- [x] T092 Implement invisible node filtering in `lib/altnode-transform.ts`: early return null when `visible === false`
- [x] T093 Implement GROUP node inlining: skip GROUP wrapper, process children directly with cumulative rotation parameter
- [x] T094 Add unique name generation with suffix counters (e.g., "Button_01" for second Button)

#### HIGH Priority Enhancements (Quality Improvements)
- [x] T095 Add metadata properties to AltNode: `canBeFlattened`, `svg`, `base64`, `uniqueName`, `cumulativeRotation`
- [x] T096 Implement `isLikelyIcon()` function: type check (VECTOR, BOOLEAN_OPERATION, etc.), size check (â‰¤64px), export settings check
- [x] T097 Add rotation conversion from radians to degrees: `-rotation * (180 / Math.PI)`
- [x] T098 Optimize empty containers: convert empty FRAME/INSTANCE/COMPONENT to RECTANGLE, reprocess
- [x] T099 Fix `toPascalCase()` validation in lib/code-generators/helpers.ts: prefix numeric-leading names with "Component"
- [x] T100 Add arbitrary value fallback for Tailwind: generate `gap-[13px]` when no standard class matches
- [ ] T101 Implement context-aware FILL sizing: generate `flex-1` instead of `w-full` when parent is horizontal flex container (TODO: documented in helpers.ts)
- [ ] T102 Add individual border width support: separate handling for `strokeTopWeight`, `strokeBottomWeight`, etc. â†’ `border-t-2 border-b-0` (TODO: documented in helpers.ts)
- [ ] T103 Implement hex-to-Tailwind color mapping: `nearestColorFromRgb()` function with color distance calculation (TODO: documented in helpers.ts)
- [ ] T104 Add shadow pattern matching: map standard Figma shadows to `shadow-sm`, `shadow-md`, `shadow-lg` (TODO: documented in helpers.ts)
- [ ] T105 Add blend mode conversion: map Figma blend modes to `mix-blend-multiply`, `mix-blend-screen`, etc. (TODO: documented in helpers.ts)
- [x] T106 Add layout wrap support: detect `layoutWrap: "WRAP"` and generate `flex-wrap` class

#### MEDIUM Priority Enhancements (Nice-to-Have)
- [ ] T107 [P] Create TailwindBuilder class in lib/code-generators/tailwind-builder.ts: progressive accumulation with chained methods (TODO: documented in helpers.ts)
- [ ] T108 [P] Optimize padding classes: consolidate to `px-4` when left===right, `py-4` when top===bottom (TODO: documented in helpers.ts)
- [x] T109 [P] Add opacity conversion: map 0-1 opacity to Tailwind scale (0, 25, 50, 75, 100)
- [ ] T110 [P] Add debug data attributes: `data-figma-id`, `data-figma-name`, `data-figma-type` in development mode (TODO: documented in helpers.ts)
- [ ] T111 [P] Add Tailwind v4 optimizations: use `size-X` when width===height (TODO: documented in helpers.ts)
- [x] T112 [P] Add rotation Tailwind classes: map rotation values to `rotate-45`, `rotate-[47deg]`, etc.

#### Testing & Validation
- [x] T113 Add edge case tests: invisible node filtering, GROUP inlining, rotation conversion, empty container optimization, icon detection
- [x] T114 Update existing altnode-transform tests to verify new properties and behaviors
- [x] T115 Add Tailwind generator tests: arbitrary values, color mapping, shadow matching, context-aware sizing
- [x] T116 Run full test suite and verify 0 regressions, all 23 improvements functional

### Implementation Notes
- **Phased approach**: CRITICAL fixes first (T090-T094), then HIGH priority (T095-T106), finally MEDIUM (T107-T112)
- **Test continuously**: Run tests after each subtask group to catch regressions early
- **Reference FigmaToCode**: See research.md Decision 7 for code examples and detailed implementation guidance
- **Update documentation**: Inline comments for complex edge case logic (GROUP inlining, rotation calculation)

### Parallel Opportunities
- T095-T106 (enhancements) can be developed in parallel after CRITICAL fixes complete
- T107-T112 (MEDIUM priority) can be developed concurrently (different files/concerns)
- T113-T116 (testing) can be written in parallel with implementation

### Dependencies
- Depends on WP02 (TypeScript types baseline), WP04 (AltNode transformation baseline), WP06 (Code generators baseline)
- Blocks WP08, WP09, WP10, WP11, WP12 (must complete CRITICAL fixes before proceeding)

### Risks & Mitigations
- **Breaking changes**: Types expansion may require updates to existing transformation logic â†’ Run tests continuously
- **Scope creep**: 27 subtasks is large â†’ Focus on CRITICAL (5) + HIGH (12) first, MEDIUM (6) optional
- **Time investment**: Estimated 8-12 hours for complete implementation â†’ Can ship MVP with CRITICAL only if time-constrained

---

## Work Package WP08: Monaco Editor Integration & Rule Editing (Priority: P1) ðŸŽ¯ MVP - User Story 2

**Goal**: Integrate Monaco Editor with JSON schema validation, real-time syntax checking, and rule library persistence.
**Independent Test**: Type invalid JSON in editor, see red squiggles; save valid rule, load from mapping-rules.json.
**Prompt**: `/tasks/planned/WP08-monaco-editor-integration-and-rule-editing.md`

### Included Subtasks
- [ ] T054 Create `components/rule-editor.tsx` wrapping `@monaco-editor/react`
- [ ] T055 Configure Monaco with JSON language server and rule-schema.json for validation
- [ ] T056 Implement rule library save/load (call `/api/rules/save` and `/api/rules/load`)
- [ ] T057 Create `app/api/rules/save/route.ts` (POST: write mapping-rules.json)
- [ ] T058 Create `app/api/rules/load/route.ts` (GET: read mapping-rules.json)
- [ ] T059 Add autocomplete for common rule patterns (Monaco suggestions API)
- [ ] T060 Test real-time validation: syntax errors highlighted with line numbers

### Implementation Notes
- Load `@monaco-editor/react` with dynamic import to reduce bundle size
- Register JSON schema in `editor.beforeMount` hook
- Save on Ctrl+S / Cmd+S keyboard shortcut
- Load existing rules on component mount (if mapping-rules.json exists)
- Display validation errors in editor gutter (red squiggles)

### Parallel Opportunities
- T057-T058 (API routes) can be developed while T054-T056 (editor component) is in progress

### Dependencies
- Depends on WP01 (Monaco dependency installed), WP02 (rule types), contracts/rule-schema.json.

### Risks & Mitigations
- **Monaco bundle size**: Confirm <500KB gzipped with dynamic import, document in plan if larger

---

## Work Package WP09: Live Preview Tabs & Code Display (Priority: P1) ðŸŽ¯ MVP - User Story 3

**Goal**: Display generated code in three tabs (React JSX, React+Tailwind, HTML/CSS) with syntax highlighting and iframe rendering. Updates within 100ms of rule changes.
**Independent Test**: Edit rule in Monaco, observe all three preview tabs update within 100ms with correct code.
**Prompt**: `/tasks/planned/WP09-live-preview-tabs-and-code-display.md`

### Included Subtasks
- [ ] T061 Create `components/preview-tabs.tsx` with Shadcn/ui Tabs (3 tabs)
- [ ] T062 Create `components/code-display.tsx` with syntax highlighting (Prism.js or Shiki)
- [ ] T063 Create `components/preview-iframe.tsx` for rendered code output
- [ ] T064 Implement debounced preview update logic (100ms debounce on rule changes)
- [ ] T065 Wire code generators to preview tabs: call react.ts, react-tailwind.ts, html-css.ts
- [ ] T066 Handle code generation errors gracefully (display error in iframe, don't crash)
- [ ] T067 Test update performance: measure time from rule edit to preview render (<100ms target)

### Implementation Notes
- Use `useMemo` to memoize code generation (only re-run when rules or AltNode change)
- Debounce rule changes with `useDebounce` hook (100ms delay)
- Iframe sandboxing: Use srcdoc attribute for HTML rendering
- Syntax highlighting: Prism.js for JSX/HTML, apply via `dangerouslySetInnerHTML` (safe here, controlled content)
- Performance: Profile with React DevTools, ensure <100ms total (rule eval + codegen + render)

### Parallel Opportunities
- T062-T063 (code display, iframe) can be developed concurrently

### Dependencies
- Depends on WP06 (code generators), WP05 (rule evaluation), WP08 (rule editing).

### Risks & Mitigations
- **100ms performance target**: If exceeded, optimize rule evaluation (memoize selector matching), simplify code generation templates

---

## Work Package WP10: Rule Matching Sidebar & Conflict Visualization (Priority: P2)

**Goal**: Show which rules matched clicked node, property contributions, and conflict highlighting.
**Independent Test**: Create conflicting rules, click node in tree, see sidebar with rules ordered by priority and conflicts highlighted.
**Prompt**: `/tasks/planned/WP10-rule-matching-sidebar-and-conflict-visualization.md`

### Included Subtasks
- [ ] T068 Create `components/node-match-sidebar.tsx` displaying matched rules for selected node
- [ ] T069 Implement click handler on tree nodes to set selected node state
- [ ] T070 Display rules ordered by priority with expandable sections
- [ ] T071 Show which properties each rule contributes (layout, colors, spacing)
- [ ] T072 Highlight conflicts in yellow (minor) and red (major) with explanations
- [ ] T073 Add "Why this won?" tooltip explaining priority resolution
- [ ] T074 Test with complex scenarios: 5 rules matching same node, multiple conflicts

### Implementation Notes
- Use Shadcn/ui Sheet or Dialog for sidebar (slide in from right)
- Group properties by category (Layout, Colors, Typography, Spacing)
- Conflict detection: Compare properties from different rules, flag if values differ
- Tooltip with conflict explanation: "Priority 20 > Priority 10, so `htmlTag: button` wins"

### Parallel Opportunities
- T070-T073 can be developed iteratively (add features incrementally)

### Dependencies
- Depends on WP05 (rule matching), WP07 (tree view with click handlers), WP09 (preview updates).

### Risks & Mitigations
- **Complex UI for many rules**: Limit display to top 10 matching rules, add "Show all" button

---

## Work Package WP11: Multi-Node Testing & Rule Library Management (Priority: P2)

**Goal**: Load multiple Figma nodes to test rule generality, manage rule library (save/load/export).
**Independent Test**: Load node A, create rules, load node B, verify rules apply correctly.
**Prompt**: `/tasks/planned/WP11-multi-node-testing-and-rule-library-management.md`

### Included Subtasks
- [ ] T075 Add "Load different node" input field (reuse fetch flow from WP07)
- [ ] T076 Implement node switching: replace current AltNode, re-evaluate rules, update previews
- [ ] T077 Display multiple node comparison side-by-side (optional: split view)
- [ ] T078 Add export button to download mapping-rules.json
- [ ] T079 Add import button to upload existing rule library
- [ ] T080 Show rule library metadata (version, last modified, rule count)
- [ ] T081 Test rule generality workflow: button variant A â†’ rules â†’ button variant B

### Implementation Notes
- Node switching: Clear previous AltNode state, call `/api/figma/fetch` with new node ID
- Export: Use browser `download` API, filename `mapping-rules-{timestamp}.json`
- Import: File input, validate JSON schema before loading
- Side-by-side comparison (optional stretch goal): Two tree views + two preview panes

### Parallel Opportunities
- T078-T080 (export/import) can be developed while T075-T077 (node switching) is in progress

### Dependencies
- Depends on WP07 (fetch flow), WP08 (rule library), WP09 (preview updates).

### Risks & Mitigations
- **Side-by-side comparison complexity**: Mark as stretch goal, implement if time permits

---

## Work Package WP12: Error Handling, Polish & Documentation (Priority: P3)

**Goal**: Comprehensive error handling, loading states, empty states, and user-facing documentation.
**Independent Test**: Trigger all error scenarios (invalid token, network failure, malformed JSON), verify clear error messages.
**Prompt**: `/tasks/planned/WP12-error-handling-polish-and-documentation.md`

### Included Subtasks
- [ ] T082 Add error boundaries for React component crashes
- [ ] T083 Implement toast notifications for user actions (save success, fetch error)
- [ ] T084 Add empty states: no Figma node loaded, no rules created, no preview available
- [ ] T085 Create help tooltips for key features (Monaco shortcuts, rule priority explanation)
- [ ] T086 Write comprehensive README.md with screenshots and examples
- [ ] T087 Update quickstart.md with actual UI screenshots and paths
- [ ] T088 Add keyboard shortcuts (Ctrl+S save, Cmd+K command palette)
- [ ] T089 Validate quickstart.md workflow end-to-end (manual test)

### Implementation Notes
- Error boundaries: Wrap app/, components/ in `<ErrorBoundary>` with fallback UI
- Toast: Use Shadcn/ui Toast component (shadcn-ui toast)
- Empty states: Shadcn/ui EmptyState with helpful CTAs ("Load a Figma node to get started")
- Help tooltips: Shadcn/ui Tooltip, trigger on hover or `?` icon click
- README: Include architecture diagram, setup steps, example workflow with screenshots

### Parallel Opportunities
- T082-T085 (error handling, UI polish) and T086-T089 (documentation) can proceed concurrently

### Dependencies
- Depends on all previous work packages (polish applies across entire app).

### Risks & Mitigations
- **Documentation drift**: Update README in same PR as UI changes to keep in sync

---

## Dependency & Execution Summary

**Sequence**:
1. **WP01** (Setup) â†’ **WP02** (Types)
2. **WP03** (Figma API), **WP04** (AltNode Transform), **WP05** (Rule Engine) can start after WP02 (types available)
3. **WP06** (Code Generators) starts after WP05 (needs resolved properties)
4. **WP07** (UI Layout), **WP08** (Monaco Editor) can start after WP03-WP04 (data + types available)
5. **WP09** (Preview Tabs) starts after WP06 + WP08 (generators + rules available)
6. **WP10** (Matching Sidebar), **WP11** (Multi-Node Testing) start after WP09 (core UI complete)
7. **WP12** (Polish) runs last (applies across entire app)

**Parallelization**:
- WP03, WP04, WP05 can run concurrently after WP02
- WP07, WP08 can run concurrently after WP03-WP04
- Within each work package, subtasks marked `[P]` are parallel-safe

**MVP Scope** (Minimum for User Stories 1-3):
- WP01, WP02, WP03, WP04, WP05, WP06, WP07, WP08, WP09 (covers all P1 user stories)
- WP10, WP11 optional for MVP (P2 user stories)
- WP12 essential for production readiness (error handling, docs)

**Critical Path**: WP01 â†’ WP02 â†’ WP03/WP04 â†’ WP05 â†’ WP06 â†’ WP09 (longest dependency chain)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? | File Path |
|------------|---------|--------------|----------|-----------|-----------|
| T001 | Init Next.js project | WP01 | P0 | No | Root |
| T002 | Config TS strict | WP01 | P0 | No | tsconfig.json |
| T003 | Install dependencies | WP01 | P0 | Yes | package.json |
| T004 | Setup Tailwind + Shadcn/ui | WP01 | P0 | Yes | tailwind.config.ts |
| T005 | Create folder structure | WP01 | P0 | Yes | app/, components/, lib/ |
| T006 | .env.local + .gitignore | WP01 | P0 | No | .env.local, .gitignore |
| T007 | Setup Vitest | WP01 | P0 | Yes | vitest.config.ts |
| T008 | Setup Playwright | WP01 | P0 | Yes | playwright.config.ts |
| T009 | Create README | WP01 | P0 | Yes | README.md |
| T010 | Verify build | WP01 | P0 | No | Build check |
| T011 | Create figma.ts types | WP02 | P0 | Yes | lib/types/figma.ts |
| T012 | Create altnode.ts types | WP02 | P0 | Yes | lib/types/altnode.ts |
| T013 | Create rule.ts types | WP02 | P0 | Yes | lib/types/rule.ts |
| T014 | Create generated-code.ts types | WP02 | P0 | Yes | lib/types/generated-code.ts |
| T015 | Verify types compile | WP02 | P0 | No | Type check |
| T016 | Create validation utils | WP02 | P0 | No | lib/utils/validation.ts |
| T017 | Create figma-client.ts | WP03 | P1 | No | lib/figma-client.ts |
| T018 | Create file-storage.ts | WP03 | P1 | Yes | lib/utils/file-storage.ts |
| T019 | API route: fetch | WP03 | P1 | No | app/api/figma/fetch/route.ts |
| T020 | API route: refresh | WP03 | P1 | No | app/api/figma/refresh/route.ts |
| T021 | Error handling | WP03 | P1 | No | lib/figma-client.ts |
| T022 | Test with mocks | WP03 | P1 | No | __tests__/unit/figma-client.test.ts |
| T023 | Verify offline mode | WP03 | P1 | No | Integration test |
| T024 | Create altnode-transform.ts | WP04 | P1 | No | lib/altnode-transform.ts |
| T025 | normalizeLayout() | WP04 | P1 | Yes | lib/altnode-transform.ts |
| T026 | normalizeFills() | WP04 | P1 | Yes | lib/altnode-transform.ts |
| T027 | normalizeStrokes() | WP04 | P1 | Yes | lib/altnode-transform.ts |
| T028 | normalizeEffects() | WP04 | P1 | Yes | lib/altnode-transform.ts |
| T029 | normalizeText() | WP04 | P1 | Yes | lib/altnode-transform.ts |
| T030 | Handle edge cases | WP04 | P1 | No | lib/altnode-transform.ts |
| T031 | Test transformation | WP04 | P1 | No | __tests__/unit/altnode-transform.test.ts |
| T032 | Verify performance | WP04 | P1 | No | Benchmark test |
| T033 | Create rule-engine.ts | WP05 | P1 | No | lib/rule-engine.ts |
| T034 | selectorMatches() | WP05 | P1 | Yes | lib/rule-engine.ts |
| T035 | resolveConflicts() | WP05 | P1 | Yes | lib/rule-engine.ts |
| T036 | Conflict detection | WP05 | P1 | Yes | lib/rule-engine.ts |
| T037 | Property provenance | WP05 | P1 | No | lib/rule-engine.ts |
| T038 | Test rule matching | WP05 | P1 | No | __tests__/unit/rule-engine.test.ts |
| T039 | Benchmark performance | WP05 | P1 | No | Benchmark test |
| T040 | Generator: react.ts | WP06 | P1 | Yes | lib/code-generators/react.ts |
| T041 | Generator: react-tailwind.ts | WP06 | P1 | Yes | lib/code-generators/react-tailwind.ts |
| T042 | Generator: html-css.ts | WP06 | P1 | Yes | lib/code-generators/html-css.ts |
| T043 | Helper functions | WP06 | P1 | No | lib/code-generators/helpers.ts |
| T044 | Syntax highlighting prep | WP06 | P1 | No | Research Prism.js/Shiki |
| T045 | Test generated code | WP06 | P1 | No | __tests__/unit/code-generators.test.ts |
| T046 | Verify code readability | WP06 | P1 | No | Manual inspection |
| T047 | Create app/page.tsx layout | WP07 | P1 | No | app/page.tsx |
| T048 | Input form (URL + node ID) | WP07 | P1 | No | app/page.tsx |
| T049 | Fetch handler | WP07 | P1 | No | app/page.tsx |
| T050 | figma-tree-view.tsx | WP07 | P1 | Yes | components/figma-tree-view.tsx |
| T051 | Match count badges | WP07 | P1 | Yes | components/figma-tree-view.tsx |
| T052 | Style panels | WP07 | P1 | No | app/page.tsx |
| T053 | Test fetch flow | WP07 | P1 | No | E2E test |
| T054 | rule-editor.tsx | WP08 | P1 | No | components/rule-editor.tsx |
| T055 | Monaco JSON config | WP08 | P1 | No | components/rule-editor.tsx |
| T056 | Save/load logic | WP08 | P1 | No | components/rule-editor.tsx |
| T057 | API route: save rules | WP08 | P1 | Yes | app/api/rules/save/route.ts |
| T058 | API route: load rules | WP08 | P1 | Yes | app/api/rules/load/route.ts |
| T059 | Autocomplete patterns | WP08 | P1 | No | components/rule-editor.tsx |
| T060 | Test validation | WP08 | P1 | No | Component test |
| T061 | preview-tabs.tsx | WP09 | P1 | No | components/preview-tabs.tsx |
| T062 | code-display.tsx | WP09 | P1 | Yes | components/code-display.tsx |
| T063 | preview-iframe.tsx | WP09 | P1 | Yes | components/preview-iframe.tsx |
| T064 | Debounced preview logic | WP09 | P1 | No | components/preview-tabs.tsx |
| T065 | Wire generators to tabs | WP09 | P1 | No | components/preview-tabs.tsx |
| T066 | Error handling | WP09 | P1 | No | components/preview-iframe.tsx |
| T067 | Test performance (<100ms) | WP09 | P1 | No | Performance test |
| T068 | node-match-sidebar.tsx | WP10 | P2 | No | components/node-match-sidebar.tsx |
| T069 | Click handler on tree | WP10 | P2 | No | components/figma-tree-view.tsx |
| T070 | Display rules by priority | WP10 | P2 | No | components/node-match-sidebar.tsx |
| T071 | Show property contributions | WP10 | P2 | No | components/node-match-sidebar.tsx |
| T072 | Conflict highlighting | WP10 | P2 | No | components/node-match-sidebar.tsx |
| T073 | "Why this won?" tooltip | WP10 | P2 | No | components/node-match-sidebar.tsx |
| T074 | Test complex scenarios | WP10 | P2 | No | Integration test |
| T075 | Multi-node input field | WP11 | P2 | No | app/page.tsx |
| T076 | Node switching logic | WP11 | P2 | No | app/page.tsx |
| T077 | Side-by-side comparison | WP11 | P2 | No | Optional stretch goal |
| T078 | Export rules button | WP11 | P2 | Yes | app/page.tsx |
| T079 | Import rules button | WP11 | P2 | Yes | app/page.tsx |
| T080 | Rule library metadata | WP11 | P2 | Yes | components/rule-library-info.tsx |
| T081 | Test rule generality | WP11 | P2 | No | E2E test |
| T082 | Error boundaries | WP12 | P3 | No | app/error.tsx |
| T083 | Toast notifications | WP12 | P3 | No | Use Shadcn/ui Toast |
| T084 | Empty states | WP12 | P3 | No | Components |
| T085 | Help tooltips | WP12 | P3 | No | Components |
| T086 | README with screenshots | WP12 | P3 | Yes | README.md |
| T087 | Update quickstart.md | WP12 | P3 | Yes | quickstart.md |
| T088 | Keyboard shortcuts | WP12 | P3 | No | app/page.tsx |
| T089 | Validate quickstart workflow | WP12 | P3 | No | Manual test |

---

> This task breakdown enables the implementation team to pick up any work package and deliver it end-to-end. Each work package has a corresponding detailed prompt file in `/tasks/planned/` with exhaustive implementation guidance.
